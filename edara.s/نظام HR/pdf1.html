<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edara — نظام إدارة الموظفين</title>
  <style>
  :root {
  --primary: #7e57c2;
  --primary-light: #b085f5;
  --primary-dark: #4d2c91;
  --primary-ultralight: #f3e5f5;
  --secondary: #f5f5f7;
  --text: #2d3748;
  --text-light: #718096;
  --text-lighter: #a0aec0;
  --white: #ffffff;
  --border: #e2e8f0;
  --shadow: 0 4px 20px rgba(126, 87, 194, 0.08);
  --shadow-hover: 0 8px 30px rgba(126, 87, 194, 0.12);
  --radius: 12px;
  --radius-sm: 8px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
* { box-sizing: border-box; margin:0; padding:0 }
html,body{height:100%}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f9f7ff 0%, #f0ebfa 100%);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  direction: rtl;
}
.app { display:flex; min-height:100vh }
.sidebar { width:280px; background:var(--white); box-shadow:var(--shadow); display:flex; flex-direction:column; position:fixed; height:100vh; z-index:100; border-left:1px solid var(--border); }
.brand { padding:24px 20px; display:flex; gap:12px; align-items:center; border-bottom:1px solid var(--border); }
.logo { width:40px; height:40px; background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; color:var(--white); font-weight:bold; font-size:18px; box-shadow:0 4px 12px rgba(126,87,194,0.3); }
.brand-text .title { font-size:20px; font-weight:700; color:var(--primary-dark); }
.brand-text .subtitle { font-size:12px; color:var(--text-light); margin-top:2px }
.menu { flex:1; padding:20px 0; overflow-y:auto }
.menu-btn { width:100%; padding:14px 20px; text-align:right; background:none; border:none; color:var(--text-light); font-size:14px; cursor:pointer; transition:var(--transition); position:relative; border-left:3px solid transparent }
.menu-btn:hover { background:var(--primary-ultralight); color:var(--primary); border-left-color:var(--primary-light) }
.menu-btn.active { background:var(--primary-ultralight); color:var(--primary-dark); border-left-color:var(--primary); font-weight:600 }
.sidebar-bottom { padding:20px; border-top:1px solid var(--border); display:flex; gap:10px }
.main { flex:1; margin-right:280px; padding:0; background:transparent }
.topbar { background:var(--white); padding:20px 30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.04); border-bottom:1px solid var(--border) }
.topbar h1 { font-size:24px; font-weight:700; color:var(--primary-dark); margin-bottom:4px }
.small.muted { font-size:13px; color:var(--text-light) }
.user { padding:8px 16px; background:var(--primary-ultralight); border-radius:var(--radius-sm); color:var(--primary); font-size:14px; font-weight:500 }
.content { padding:5px 24px 40px; min-height:auto }
.page { display:none }
.page.active { display:block; animation:fadeIn 0.4s ease }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px }
.card { background:var(--white); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); border:1px solid var(--border); transition:var(--transition) }
.card:hover { box-shadow:var(--shadow-hover); transform:translateY(-2px) }
.card.wide { grid-column:1 / -1 }
.card h3 { font-size:18px; font-weight:600; color:var(--primary-dark); margin-bottom:12px }
.btn { background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); color:var(--white); border:none; padding:10px 20px; border-radius:var(--radius-sm); cursor:pointer; font-size:14px; font-weight:500; transition:var(--transition); box-shadow:0 2px 8px rgba(126,87,194,0.2) }
.btn:hover { transform:translateY(-1px); box-shadow:0 4px 15px rgba(126,87,194,0.3) }
.btn.ghost { background:transparent; color:var(--primary); border:1px solid var(--primary-light); box-shadow:none }
.btn.ghost:hover { background:var(--primary-ultralight); transform:none; box-shadow:none }
.btn.small { padding:6px 12px; font-size:12px }
.panel { background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--border); overflow:hidden }
.panel-head { padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--white) }
.panel-head h2 { font-size:20px; font-weight:600; color:var(--primary-dark) }
.panel-body { padding:24px }
.toolbar { display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap; align-items:center }
.toolbar input, .toolbar select { padding:10px 14px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--white); font-size:14px; transition:var(--transition); min-width:200px }
.toolbar input:focus, .toolbar select:focus { outline:none; border-color:var(--primary-light); box-shadow:0 0 0 3px rgba(126,87,194,0.1) }
.table-wrap { border:1px solid var(--border); border-radius:var(--radius-sm); overflow:hidden }
.table { width:100%; border-collapse:collapse; background:var(--white) }
.table th { background:var(--primary-ultralight); padding:14px 16px; text-align:right; font-weight:600; color:var(--primary-dark); font-size:14px; border-bottom:1px solid var(--border) }
.table td { padding:14px 16px; border-bottom:1px solid var(--border); font-size:14px }
.table tr:last-child td { border-bottom:none }
.table tr:hover { background:var(--primary-ultralight) }
.log { max-height:400px; overflow-y:auto; border:1px solid var(--border); border-radius:var(--radius-sm); padding:16px; background:var(--white) }
.log-item { padding:12px; border-bottom:1px solid var(--border); font-size:14px }
.log-item:last-child { border-bottom:none }
.log-item strong { color:var(--primary-dark) }
.form { display:flex; flex-direction:column; gap:16px }
.form label { font-weight:500; color:var(--text); font-size:14px; margin-bottom:4px }
.form input { padding:12px 16px; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:14px; transition:var(--transition) }
.form input:focus { outline:none; border-color:var(--primary-light); box-shadow:0 0 0 3px rgba(126,87,194,0.1) }
.modal { position:fixed; top:0; right:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(4px) }
.modal-box { background:var(--white); border-radius:var(--radius); padding:30px; width:90%; max-width:900px; box-shadow:0 20px 60px rgba(0,0,0,0.2); animation:modalSlideIn 0.3s ease }
@keyframes modalSlideIn { from{opacity:0; transform:translateY(-20px) scale(0.95)} to{opacity:1; transform:translateY(0) scale(1)} }
.modal-actions { display:flex; gap:12px; margin-top:20px; justify-content:flex-end }
.setting-row { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid var(--border) }
.setting-row:last-child { border-bottom:none }
.shortcuts-list { list-style:none; padding:0 }
.shortcuts-list li { padding:10px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between }
.shortcuts-list li:last-child { border-bottom:none }
.shortcuts-list strong { color:var(--primary-dark) }
.actions-vertical { display:flex; flex-direction:column; gap:12px }
.dropdown { position:relative; display:inline-block; margin-bottom:12px; width:100%; max-width:300px }
.dropdown input { width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; margin-bottom:6px; font-size:14px }
.dropdown-toggle { background:#7b2cbf; color:#fff; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; width:100% }
.dropdown-toggle:hover { background:#5a189a }
.dropdown-menu { position:absolute; top:100%; right:0; background:#fff; min-width:100%; max-height:200px; overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.1); border-radius:8px; display:none; z-index:10 }
.dropdown-menu.active { display:block }
.dropdown-menu div { padding:10px; cursor:pointer; transition:background 0.2s }
.dropdown-menu div:hover { background:#f2f2f2 }
.log-item { background:#f8f8ff; border:1px solid #e6e6f5; border-radius:8px; padding:8px 10px; margin-top:8px; display:flex; justify-content:space-between; align-items:center }
.log-item strong { color:#5a189a }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; overflow-y:auto; padding:20px; z-index:1000 }
.modal-box { background:#fff; color:#333; width:95%; max-width:1000px; max-height:90vh; display:flex; flex-direction:column; border-radius:12px; overflow:hidden; border-top:6px solid #8e44ad; box-shadow:0 8px 20px rgba(0,0,0,0.3) }
.modal-header { padding:16px 20px; background:#8e44ad; color:#fff; font-size:1.2em; font-weight:bold }
.modal-content { padding:16px 20px; flex-grow:1; overflow-y:auto; display:flex; flex-direction:column; gap:12px }
.modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:10px 12px; border-radius:6px; border:1px solid #ccc; font-size:1em }
.modal-actions { padding:12px 20px; background:#f9f9f9; display:flex; justify-content:flex-end; gap:10px }
.modal-actions .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-weight:bold }
.modal-actions .btn.ghost { background:transparent; border:1px solid #8e44ad; color:#8e44ad }
.modal-actions .btn:not(.ghost) { background:#8e44ad; color:#fff }
@media (max-width:1024px){ .sidebar{width:240px} .main{margin-right:240px} .grid{grid-template-columns:1fr} }
@media (max-width:768px){ .sidebar{transform:translateX(100%); transition:transform 0.3s ease} .sidebar.open{transform:translateX(0)} .main{margin-right:0} .topbar{padding:15px 20px} .content{padding:20px} .toolbar{flex-direction:column; align-items:stretch} .toolbar input,.toolbar select{min-width:auto} }
.muted { color:var(--text-light) !important }
.small { font-size:13px !important }
.text-center { text-align:center !important }
::-webkit-scrollbar { width:6px }
::-webkit-scrollbar-track { background:var(--secondary) }
::-webkit-scrollbar-thumb { background:var(--primary-light); border-radius:3px }
::-webkit-scrollbar-thumb:hover { background:var(--primary) }

  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" role="navigation" aria-label="القائمة الجانبية">
      <div class="brand">
        <div class="logo">Ed</div>
        <div class="brand-text">
          <div class="title">edara</div>
          <div class="subtitle">نظام إدارة الموظفين</div>
        </div>
      </div>
      <nav class="menu" id="menu">
        <button class="menu-btn active" data-page="dashboard">لوحة التحكم</button>
        <button class="menu-btn" data-page="employees">الموظفين</button>
        <button class="menu-btn" data-page="attendance">الحضور والانصراف</button>
        <button class="menu-btn" data-page="leaves">الإجازات</button>
        <button class="menu-btn" data-page="loans">السلف</button>
        <button class="menu-btn" data-page="reports">التقارير</button>
        <button class="menu-btn" data-page="settings">الإعدادات</button>
        <button class="menu-btn" data-page="shortcuts">الاختصارات</button>
      </nav>
      <div class="sidebar-bottom">
        <button class="btn ghost" id="exportBtn">تصدير</button>
        <button class="btn ghost" id="importBtn">استيراد</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1>لوحة التحكم</h1>
          <div class="small muted">نظام edara — إدارة الموظفين</div>
        </div>
        <div class="user" id="currentUser">المسؤول</div>
      </div>

      <div class="content">
        <!-- Dashboard -->
        <section class="page active" id="dashboard">
          <div class="grid">
            <div class="card">
              <h3>نظرة عامة</h3>
              <div class="panel-body" id="overviewBody">
                <p class="muted">لا توجد بيانات أولية. أضف موظفين من قسم "الموظفين".</p>
              </div>
            </div>
            <div class="card">
              <h3>آخر الأنشطة</h3>
              <div class="log" id="activityLog"></div>
            </div>
            <div class="card wide">
              <h3>الحضور اليومي</h3>
              <div id="todayAttendance" class="panel-body">
                <p class="muted">لا توجد مدخلات حضور لليوم.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Employees -->
        <section class="page" id="employees">
          <div class="panel">
            <div class="panel-head">
              <h2>الموظفين</h2>
              <div class="actions-vertical">
                <div class="toolbar">
                  <input type="text" id="empSearchInput" placeholder="ابحث عن موظف..." />
                  <button class="btn" id="addEmployeeBtn">إضافة موظف</button>
                </div>
              </div>
            </div>
            <div class="panel-body">
              <div class="table-wrap">
                <table class="table" id="employeesTable">
                  <thead>
                    <tr>
                      <th>اسم</th>
                      <th>وظيفة</th>
                      <th>القسم</th>
                      <th>الراتب الأساسي</th>
                      <th>هاتف</th>
                      <th>إجراءات</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Attendance -->
        <section class="page" id="attendance">
          <div class="grid">
            <div class="card">
              <h3>تسجيل الحضور</h3>
              <div class="panel-body">
                <div class="toolbar">
                  <select id="attEmpSelect"></select>
                  <button class="btn" id="manualIn">تسجيل دخول يدوي</button>
                  <button class="btn" id="manualOut">تسجيل خروج يدوي</button>
                </div>
                <hr />
                <h4>ميزة البصمة (محاكاة)</h4>
                <p class="muted">الخاصية تشتغل بالمحاكاة داخل المتصفح؛ يمكن ربط WebAuthn أو جهاز خارجي لاحقًا.</p>
                <div class="toolbar">
                  <select id="bioEmpSelect"></select>
                  <button class="btn" id="bioIn">دخول ببصمة</button>
                  <button class="btn" id="bioOut">خروج ببصمة</button>
                </div>
              </div>
            </div>

            <div class="card">
              <h3>سجل الحضور</h3>
              <div class="panel-body">
                <div class="toolbar">
                  <input type="date" id="attDate" />
                  <button class="btn ghost" id="filterAtt">تصفية</button>
                  <button class="btn ghost" id="clearAttFilter">عرض الكل</button>
                </div>
                <div class="table-wrap">
                  <table class="table" id="attendanceTable">
                    <thead>
                      <tr><th>الموظف</th><th>تاريخ</th><th>دخول</th><th>خروج</th><th>مصدر</th></tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Leaves -->
        <section class="page" id="leaves">
          <div class="panel">
            <div class="panel-head">
              <h2>الإجازات</h2>
              <div class="toolbar">
                <select id="leaveEmpSelect"></select>
                <button class="btn" id="requestLeaveBtn">تقديم طلب إجازة</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="table-wrap">
                <table class="table" id="leavesTable">
                  <thead>
                    <tr><th>الموظف</th><th>من</th><th>إلى</th><th>نوع</th><th>الحالة</th><th>إجراءات</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Loans -->
        <section class="page" id="loans">
          <div class="panel">
            <div class="panel-head">
              <h2>السلف</h2>
              <div class="toolbar">
                <select id="loanEmpSelect"></select>
                <button class="btn" id="addLoanBtn">إضافة / تعديل سلفة</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="table-wrap">
                <table class="table" id="loanTable">
                  <thead>
                    <tr><th>الموظف</th><th>المبلغ</th><th>التاريخ</th><th>الحالة</th><th>إجراءات</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section class="page" id="reports">
          <div class="panel">
            <div class="panel-head">
              <h2>التقارير</h2>
              <div class="toolbar">
                <select id="reportEmpSelect"></select>
                <button class="btn" id="viewReportBtn">عرض تقرير الموظف</button>
              </div>
            </div>
            <div class="panel-body" id="reportBody">
              <p class="muted">اختر موظفًا ثم اضغط "عرض تقرير الموظف".</p>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section class="page" id="settings">
          <div class="panel">
            <div class="panel-head">
              <h2>الإعدادات</h2>
            </div>
            <div class="panel-body">
              <div class="form">
                <div class="setting-row"><label>الحفظ التلقائي</label><input type="checkbox" id="autoSave" /></div>
                <div class="setting-row"><label>إعادة ضبط البيانات</label><button class="btn ghost" id="resetBtn">إعادة ضبط</button></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Shortcuts -->
        <section class="page" id="shortcuts">
          <div class="card wide">
            <h3>الاختصارات عبر الكيبورد</h3>
            <div class="panel-body">
              <ul class="shortcuts-list" id="shortcutsList">
                <li><span>Shift + 1</span><strong>انتقل إلى لوحة التحكم</strong></li>
                <li><span>Shift + 2</span><strong>الموظفين</strong></li>
                <li><span>Shift + 3</span><strong>الحضور والانصراف</strong></li>
                <li><span>Shift + 4</span><strong>الإجازات</strong></li>
                <li><span>Shift + 5</span><strong>السلف</strong></li>
                <li><span>Shift + 6</span><strong>التقارير</strong></li>
                <li><span>Shift + 7</span><strong>الإعدادات</strong></li>
                <li><span>Shift + 8</span><strong>الاختصارات</strong></li>
              </ul>
            </div>
          </div>
        </section>

      </div>
    </main>

    <!-- Modals -->
    <div class="modal" id="empModal">
      <div class="modal-box">
        <div class="modal-header">إضافة / تعديل موظف</div>
        <div class="modal-content">
          <input placeholder="الاسم" id="empName" />
          <input placeholder="الوظيفة" id="empJob" />
          <input placeholder="القسم" id="empDept" />
          <input placeholder="الراتب الأساسي" id="empSalary" type="number" />
          <input placeholder="الهاتف" id="empPhone" />
          <input placeholder="معرف البصمة (رقم) - اختياري" id="empBioId" />
        </div>
        <div class="modal-actions">
          <button class="btn ghost" id="closeEmpModal">إلغاء</button>
          <button class="btn" id="saveEmpBtn">حفظ</button>
        </div>
      </div>
    </div>

    <div class="modal" id="leaveModal">
      <div class="modal-box">
        <div class="modal-header">طلب إجازة</div>
        <div class="modal-content">
          <select id="leaveEmp"></select>
          <input type="date" id="leaveFrom" />
          <input type="date" id="leaveTo" />
          <select id="leaveType"><option>سنوية</option><option>مرضية</option><option>عائلية</option></select>
          <textarea id="leaveReason" placeholder="سبب الإجازة"></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn ghost" id="closeLeaveModal">إلغاء</button>
          <button class="btn" id="saveLeaveBtn">إرسال</button>
        </div>
      </div>
    </div>

    <div class="modal" id="loanModal">
      <div class="modal-box">
        <div class="modal-header">إضافة / تعديل سلفة</div>
        <div class="modal-content">
          <select id="loanEmp"></select>
          <input id="loanAmount" placeholder="المبلغ" type="number" />
          <input id="loanDate" type="date" />
          <select id="loanStatus">
            <option value="معلق">معلق</option>
            <option value="موافق">موافق</option>
            <option value="مرفوض">مرفوض</option>
            <option value="مسدد">مسدد</option>
          </select>
          <div id="salaryInfo" class="muted small"></div>
        </div>
        <div class="modal-actions">
          <button class="btn ghost" id="closeLoanModal">إلغاء</button>
          <button class="btn" id="saveLoanBtn">حفظ</button>
        </div>
      </div>
    </div>

    <input type="file" id="importFile" accept="application/json" style="display:none" />
  </div>

  <script>
  // Simple data storage via localStorage
  const DB_KEY = 'edara_db_v2';
  let db = { employees:[], attendance:[], leaves:[], loans:[], activities:[] };

  function loadDB(){
    const raw = localStorage.getItem(DB_KEY);
    if(raw) db = JSON.parse(raw);
  }
  function saveDB(){
    if(document.getElementById('autoSave').checked) {
      localStorage.setItem(DB_KEY, JSON.stringify(db));
      logActivity('تم حفظ تلقائي للبيانات');
    }
  }
  function forceSave(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

  // Initialize
  loadDB();

  // UI helpers
  const pages = document.querySelectorAll('.page');
  document.querySelectorAll('.menu-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ openPage(btn.dataset.page); })
  });
  function openPage(id){
    document.querySelectorAll('.menu-btn').forEach(b=>b.classList.toggle('active', b.dataset.page===id));
    pages.forEach(p=>p.classList.toggle('active', p.id===id));
    document.querySelector('.topbar h1').textContent = ({dashboard:'لوحة التحكم', employees:'الموظفين', attendance:'الحضور والانصراف', leaves:'الإجازات', loans:'السلف', reports:'التقارير', settings:'الإعدادات', shortcuts:'الاختصارات'})[id] || 'edara';
    renderAll();
  }

  // Activities log
  function logActivity(text){
    db.activities.unshift({time:new Date().toISOString(), text});
    if(db.activities.length>200) db.activities.pop();
    renderActivities();
    if(document.getElementById('autoSave').checked) forceSave();
  }

  function renderActivities(){
    const el = document.getElementById('activityLog'); el.innerHTML='';
    if(!db.activities.length){ el.innerHTML='<p class="muted">لا توجد أنشطة بعد.</p>'; return; }
    db.activities.forEach(a=>{
      const div = document.createElement('div'); div.className='log-item';
      div.innerHTML = `<div><strong>${a.text}</strong><div class="small muted">${new Date(a.time).toLocaleString()}</div></div>`;
      el.appendChild(div);
    });
  }

  // Employees CRUD
  function renderEmployees(){
    const tbody = document.querySelector('#employeesTable tbody'); tbody.innerHTML='';
    db.employees.forEach(emp=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${emp.name||''}</td><td>${emp.job||''}</td><td>${emp.dept||''}</td><td>${emp.salary||0}</td><td>${emp.phone||''}</td><td>
        <button class="btn small" data-id="${emp.id}" data-act="edit">تعديل</button>
        <button class="btn ghost small" data-id="${emp.id}" data-act="del">حذف</button>
      </td>`;
      tbody.appendChild(tr);
    });
    // attach events
    tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
      const id = e.target.dataset.id; const act = e.target.dataset.act;
      if(act==='edit') openEmpModal(id);
      if(act==='del') { if(confirm('حذف الموظف نهائياً؟')){ db.employees = db.employees.filter(x=>x.id!==id); logActivity('حُذف موظف'); saveDB(); renderAll(); }}
      if(act==='archive') { const emp = db.employees.find(x=>x.id===id); if(emp){ emp.archived = true; logActivity('تم أرشفة موظف'); saveDB(); renderAll(); }}
    }));
  }

  function openEmpModal(id){
    const modal = document.getElementById('empModal'); modal.style.display='flex';
    document.getElementById('empName').value=''; document.getElementById('empJob').value=''; document.getElementById('empDept').value=''; document.getElementById('empSalary').value=''; document.getElementById('empPhone').value=''; document.getElementById('empBioId').value='';
    modal.dataset.edit = id||'';
    if(id){ const emp = db.employees.find(x=>x.id===id); if(emp){ document.getElementById('empName').value=emp.name||''; document.getElementById('empJob').value=emp.job||''; document.getElementById('empDept').value=emp.dept||''; document.getElementById('empSalary').value=emp.salary||''; document.getElementById('empPhone').value=emp.phone||''; document.getElementById('empBioId').value=emp.bioId||''; }}
  }
  document.getElementById('addEmployeeBtn').addEventListener('click', ()=>openEmpModal());
  document.getElementById('closeEmpModal').addEventListener('click', ()=>{ document.getElementById('empModal').style.display='none'; });
  document.getElementById('saveEmpBtn').addEventListener('click', ()=>{
    const modal = document.getElementById('empModal'); const id = modal.dataset.edit;
    const name = document.getElementById('empName').value.trim();
    if(!name){ alert('الاسم مطلوب'); return; }
    const salary = Number(document.getElementById('empSalary').value) || 0;
    if(id){ const emp = db.employees.find(x=>x.id===id); Object.assign(emp,{name, job:document.getElementById('empJob').value, dept:document.getElementById('empDept').value, salary, phone:document.getElementById('empPhone').value, bioId:document.getElementById('empBioId').value}); logActivity('تم تعديل بيانات موظف'); }
    else{ const newEmp = { id: 'e_'+Date.now(), name, job:document.getElementById('empJob').value, dept:document.getElementById('empDept').value, salary, phone:document.getElementById('empPhone').value, bioId:document.getElementById('empBioId').value }; db.employees.push(newEmp); logActivity('تم إضافة موظف جديد'); }
    document.getElementById('empModal').style.display='none'; saveDB(); renderAll();
  });

  // Attendance
  function renderAttendance(){
    const tbody = document.querySelector('#attendanceTable tbody'); tbody.innerHTML='';
    db.attendance.forEach(a=>{
      const tr = document.createElement('tr');
      const emp = db.employees.find(e=>e.id===a.empId) || {name:'--'};
      tr.innerHTML = `<td>${emp.name}</td><td>${a.date}</td><td>${a.in||''}</td><td>${a.out||''}</td><td>${a.source||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderAttendanceSelectors(){
    ['attEmpSelect','bioEmpSelect'].forEach(id=>{
      const sel = document.getElementById(id); sel.innerHTML='';
      db.employees.filter(e=>!e.archived).forEach(e=>{ const opt = document.createElement('option'); opt.value=e.id; opt.textContent=e.name; sel.appendChild(opt);} );
    });
    ['leaveEmp','leaveEmpSelect','loanEmpSelect','loanEmp','reportEmpSelect'].forEach(id=>{
      const sel = document.getElementById(id); if(!sel) return; sel.innerHTML='';
      db.employees.filter(e=>!e.archived).forEach(e=>{ const opt=document.createElement('option'); opt.value=e.id; opt.textContent=e.name; sel.appendChild(opt); });
    });
  }

  document.getElementById('manualIn').addEventListener('click', ()=>{
    const empId = document.getElementById('attEmpSelect').value; if(!empId) { alert('اختر موظف'); return; }
    const today = new Date(); const date = today.toISOString().slice(0,10);
    let rec = db.attendance.find(x=>x.empId===empId && x.date===date);
    if(!rec) { rec = {empId, date, in: today.toTimeString().slice(0,8), out:'', source:'يدوي'}; db.attendance.push(rec); }
    else { rec.in = today.toTimeString().slice(0,8); rec.source = (rec.source||'') + ' & يدوي'; }
    logActivity('تسجيل دخول يدوي لموظف'); saveDB(); renderAll();
  });
  document.getElementById('manualOut').addEventListener('click', ()=>{
    const empId = document.getElementById('attEmpSelect').value; if(!empId) { alert('اختر موظف'); return; }
    const today = new Date(); const date = today.toISOString().slice(0,10);
    let rec = db.attendance.find(x=>x.empId===empId && x.date===date);
    if(!rec) { rec = {empId, date, in:'', out: today.toTimeString().slice(0,8), source:'يدوي'}; db.attendance.push(rec); }
    else { rec.out = today.toTimeString().slice(0,8); rec.source = (rec.source||'') + ' & يدوي'; }
    logActivity('تسجيل خروج يدوي لموظف'); saveDB(); renderAll();
  });

  // Biometric simulation (mapping bioId)
  function performBio(empId, type){
    const emp = db.employees.find(e=>e.id===empId); if(!emp){ alert('موظف غير موجود'); return; }
    const now = new Date(); const date = now.toISOString().slice(0,10);
    let rec = db.attendance.find(x=>x.empId===empId && x.date===date);
    if(!rec){ rec = {empId, date, in:'', out:'', source:'بصمة'}; db.attendance.push(rec); }
    if(type==='in') rec.in = now.toTimeString().slice(0,8);
    else rec.out = now.toTimeString().slice(0,8);
    rec.source = 'بصمة';
    logActivity(`بصمة ${type==='in'?'دخول':'خروج'} — ${emp.name}`);
    saveDB(); renderAll();
  }
  document.getElementById('bioIn').addEventListener('click', ()=>{ performBio(document.getElementById('bioEmpSelect').value,'in'); });
  document.getElementById('bioOut').addEventListener('click', ()=>{ performBio(document.getElementById('bioEmpSelect').value,'out'); });

  // Leaves
  document.getElementById('requestLeaveBtn').addEventListener('click', ()=>{ document.getElementById('leaveModal').style.display='flex'; });
  document.getElementById('closeLeaveModal').addEventListener('click', ()=>{ document.getElementById('leaveModal').style.display='none'; });
  document.getElementById('saveLeaveBtn').addEventListener('click', ()=>{
    const empId = document.getElementById('leaveEmp').value; const from = document.getElementById('leaveFrom').value; const to = document.getElementById('leaveTo').value; const type = document.getElementById('leaveType').value; const reason = document.getElementById('leaveReason').value;
    if(!empId||!from||!to){ alert('املأ الحقول المطلوبة'); return; }
    db.leaves.push({id:'L_'+Date.now(), empId, from, to, type, reason, status:'معلق'});
    logActivity('تم تقديم طلب إجازة'); saveDB(); document.getElementById('leaveModal').style.display='none'; renderAll();
  });

  function renderLeaves(){
    const tbody = document.querySelector('#leavesTable tbody'); tbody.innerHTML='';
    db.leaves.forEach(l=>{
      const emp = db.employees.find(e=>e.id===l.empId)||{name:'--'};
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${emp.name}</td><td>${l.from}</td><td>${l.to}</td><td>${l.type}</td><td>${l.status}</td><td>
        <button class="btn small" data-id="${l.id}" data-act="approve">موافقة</button>
        <button class="btn ghost small" data-id="${l.id}" data-act="reject">رفض</button>
        <button class="btn ghost small" data-id="${l.id}" data-act="del">حذف</button>
      </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
      const id = e.target.dataset.id; const act = e.target.dataset.act; const item = db.leaves.find(x=>x.id===id);
      if(!item) return;
      if(act==='approve'){ item.status='موافق'; logActivity('تم الموافقة على إجازة'); saveDB(); }
      if(act==='reject'){ item.status='مرفوض'; logActivity('تم رفض إجازة'); saveDB(); }
      if(act==='del'){ db.leaves = db.leaves.filter(x=>x.id!==id); logActivity('تم حذف إجازة'); saveDB(); }
      renderAll();
    }));
  }

  // Loans
  document.getElementById('addLoanBtn').addEventListener('click', ()=>{ document.getElementById('loanModal').style.display='flex'; });
  document.getElementById('closeLoanModal').addEventListener('click', ()=>{ document.getElementById('loanModal').style.display='none'; });
  
  // Update salary info when employee is selected in loan modal
  document.getElementById('loanEmp').addEventListener('change', function() {
    const empId = this.value;
    const emp = db.employees.find(e => e.id === empId);
    const salaryInfo = document.getElementById('salaryInfo');
    
    if (emp && emp.salary) {
      const totalLoans = db.loans
        .filter(l => l.empId === empId && l.status === 'موافق')
        .reduce((sum, loan) => sum + (loan.amount || 0), 0);
      
      const remainingSalary = emp.salary - totalLoans;
      
      salaryInfo.innerHTML = `
        <div>الراتب الأساسي: ${emp.salary}</div>
        <div>إجمالي السلف: ${totalLoans}</div>
        <div>الراتب المتبقي: ${remainingSalary}</div>
      `;
    } else {
      salaryInfo.innerHTML = emp ? `الراتب الأساسي: ${emp.salary || 0}` : '';
    }
  });

  document.getElementById('saveLoanBtn').addEventListener('click', ()=>{
    const empId = document.getElementById('loanEmp').value; 
    const amount = Number(document.getElementById('loanAmount').value||0); 
    const date = document.getElementById('loanDate').value; 
    const status = document.getElementById('loanStatus').value;
    
    if(!empId || !amount || !date){ alert('املأ الحقول المطلوبة'); return; }
    
    // Check if loan amount exceeds remaining salary
    if (status === 'موافق') {
      const emp = db.employees.find(e => e.id === empId);
      if (emp && emp.salary) {
        const totalLoans = db.loans
          .filter(l => l.empId === empId && l.status === 'موافق')
          .reduce((sum, loan) => sum + (loan.amount || 0), 0);
        
        const remainingSalary = emp.salary - totalLoans;
        
        if (amount > remainingSalary) {
          alert(`المبلغ المطلوب (${amount}) يتجاوز الراتب المتبقي (${remainingSalary})`);
          return;
        }
      }
    }
    
    const rec = db.loans.find(x=>x.empId===empId && x.date===date);
    if(rec) Object.assign(rec,{amount, status}); 
    else db.loans.push({id:'LN_'+Date.now(), empId, amount, date, status});
    
    logActivity('تم حفظ سلفة لموظف'); 
    saveDB(); 
    document.getElementById('loanModal').style.display='none'; 
    renderAll();
  });

  function renderLoans(){
    const tbody = document.querySelector('#loanTable tbody'); tbody.innerHTML='';
    db.loans.forEach(l=>{
      const emp = db.employees.find(e=>e.id===l.empId) || {name:'--'};
      const tr = document.createElement('tr'); tr.innerHTML=`<td>${emp.name}</td><td>${l.amount}</td><td>${l.date}</td><td>${l.status}</td><td>
        <button class="btn small" data-id="${l.id}" data-act="editLoan">تعديل</button>
        <button class="btn ghost small" data-id="${l.id}" data-act="delLoan">حذف</button>
      </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
      const id = e.target.dataset.id; const act = e.target.dataset.act; const rec = db.loans.find(x=>x.id===id);
      if(!rec) return; 
      if(act==='editLoan'){ 
        document.getElementById('loanModal').style.display='flex'; 
        document.getElementById('loanEmp').value=rec.empId; 
        document.getElementById('loanAmount').value=rec.amount; 
        document.getElementById('loanDate').value=rec.date; 
        document.getElementById('loanStatus').value=rec.status; 
        
        // Trigger salary info update
        document.getElementById('loanEmp').dispatchEvent(new Event('change'));
      }
      if(act==='delLoan'){ db.loans = db.loans.filter(x=>x.id!==id); logActivity('تم حذف سلفة'); saveDB(); renderAll(); }
    }));
  }

  // Reports
  document.getElementById('viewReportBtn').addEventListener('click', ()=>{
    const empId = document.getElementById('reportEmpSelect').value; if(!empId){ alert('اختر موظف'); return; }
    const emp = db.employees.find(e=>e.id===empId); 
    const att = db.attendance.filter(a=>a.empId===empId); 
    const leaves = db.leaves.filter(l=>l.empId===empId); 
    const loans = db.loans.filter(s=>s.empId===empId);
    
    const totalLoans = loans
      .filter(l => l.status === 'موافق')
      .reduce((sum, loan) => sum + (loan.amount || 0), 0);
    
    const remainingSalary = (emp.salary || 0) - totalLoans;
    
    const body = document.getElementById('reportBody'); body.innerHTML = '';
    const div = document.createElement('div'); div.innerHTML = `
      <h3>تقرير: ${emp.name}</h3>
      <p>الوظيفة: ${emp.job||'-'} — القسم: ${emp.dept||'-'}</p>
      <h4>الراتب</h4>
      <p>الراتب الأساسي: ${emp.salary||0} — إجمالي السلف: ${totalLoans} — الراتب المتبقي: ${remainingSalary}</p>
      <h4>الحضور (${att.length})</h4>
      <div class="table-wrap"><table class="table"><thead><tr><th>تاريخ</th><th>دخول</th><th>خروج</th></tr></thead><tbody>${att.map(a=>`<tr><td>${a.date}</td><td>${a.in||''}</td><td>${a.out||''}</td></tr>`).join('')}</tbody></table></div>
      <h4>الإجازات (${leaves.length})</h4>
      <div class="table-wrap"><table class="table"><thead><tr><th>من</th><th>إلى</th><th>نوع</th><th>حالة</th></tr></thead><tbody>${leaves.map(l=>`<tr><td>${l.from}</td><td>${l.to}</td><td>${l.type}</td><td>${l.status}</td></tr>`).join('')}</tbody></table></div>
      <h4>السلف (${loans.length})</h4>
      <div class="table-wrap"><table class="table"><thead><tr><th>المبلغ</th><th>التاريخ</th><th>الحالة</th></tr></thead><tbody>${loans.map(l=>`<tr><td>${l.amount}</td><td>${l.date}</td><td>${l.status}</td></tr>`).join('')}</tbody></table></div>
    `;
    body.appendChild(div);
  });

  // Render dashboard overview
  function renderOverview(){
    const el = document.getElementById('overviewBody');
    const employeesCount = db.employees.filter(e=>!e.archived).length; 
    const todays = db.attendance.filter(a=>a.date===new Date().toISOString().slice(0,10)).length;
    
    const totalSalaries = db.employees
      .filter(e => !e.archived)
      .reduce((sum, emp) => sum + (emp.salary || 0), 0);
    
    const totalLoans = db.loans
      .filter(l => l.status === 'موافق')
      .reduce((sum, loan) => sum + (loan.amount || 0), 0);
    
    el.innerHTML = `
      <div class="grid">
        <div class="card"><h3>الموظفين</h3><p class="muted">${employeesCount} موظف</p></div>
        <div class="card"><h3>حضور اليوم</h3><p class="muted">${todays} تسجيل</p></div>
        <div class="card"><h3>إجمالي الرواتب</h3><p class="muted">${totalSalaries}</p></div>
        <div class="card"><h3>إجمالي السلف</h3><p class="muted">${totalLoans}</p></div>
      </div>
    `;
    
    const ta = document.getElementById('todayAttendance'); ta.innerHTML='';
    const todayList = db.attendance.filter(a=>a.date===new Date().toISOString().slice(0,10));
    if(!todayList.length) ta.innerHTML='<p class="muted">لا توجد مدخلات اليوم.</p>';
    else { 
      const ul = document.createElement('div'); ul.className='log'; 
      todayList.forEach(a=>{ 
        const emp = db.employees.find(e=>e.id===a.empId)||{name:'--'}; 
        const d = document.createElement('div'); d.className='log-item'; 
        d.innerHTML=`<strong>${emp.name}</strong><span>${a.in||''} — ${a.out||''}</span>`; 
        ul.appendChild(d); 
      }); 
      ta.appendChild(ul); 
    }
  }

  // Shortcuts
  window.addEventListener('keydown', (e) => {
    try {
      const tag = (e.target && e.target.tagName) || '';
      if (['INPUT', 'TEXTAREA', 'SELECT'].includes(tag) || (e.target && e.target.isContentEditable)) return;
      if (!e.shiftKey) return;

      switch (e.code) {
        case 'Digit1': case 'Numpad1': openPage('dashboard'); break;
        case 'Digit2': case 'Numpad2': openPage('employees'); break;
        case 'Digit3': case 'Numpad3': openPage('attendance'); break;
        case 'Digit4': case 'Numpad4': openPage('leaves'); break;
        case 'Digit5': case 'Numpad5': openPage('loans'); break;
        case 'Digit6': case 'Numpad6': openPage('reports'); break;
        case 'Digit7': case 'Numpad7': openPage('settings'); break;
        case 'Digit8': case 'Numpad8': openPage('shortcuts'); break;
        default: break;
      }
    } catch (err) { console.error('shortcut error', err); }
  });

  // Import / Export
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const dataStr = JSON.stringify(db, null, 2); const blob = new Blob([dataStr], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'edara_export_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('importBtn').addEventListener('click', ()=>{ document.getElementById('importFile').click(); });
  document.getElementById('importFile').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const payload = JSON.parse(reader.result); if(confirm('استبدال البيانات الحالية بالملف المستورد؟')){ db = payload; forceSave(); renderAll(); logActivity('تم استيراد بيانات'); } }catch(err){ alert('ملف غير صالح'); } }; reader.readAsText(f);
  });

  // Settings
  document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('هل تريد إعادة ضبط كل البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')){ db = {employees:[], attendance:[], leaves:[], loans:[], activities:[]}; forceSave(); renderAll(); logActivity('إعادة ضبط النظام'); }});

  // Filters and search
  document.getElementById('empSearchInput').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase(); const tbody = document.querySelector('#employeesTable tbody'); tbody.innerHTML='';
    db.employees.filter(emp => emp.name.toLowerCase().includes(q) || (emp.job||'').toLowerCase().includes(q) || (emp.dept||'').toLowerCase().includes(q)).forEach(emp=>{
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${emp.name}</td><td>${emp.job||''}</td><td>${emp.dept||''}</td><td>${emp.salary||0}</td><td>${emp.phone||''}</td><td>
        <button class="btn small" data-id="${emp.id}" data-act="edit">تعديل</button>
        <button class="btn ghost small" data-id="${emp.id}" data-act="del">حذف</button>
      </td>`; tbody.appendChild(tr);
    });
  });

  // Attendance filter
  document.getElementById('filterAtt').addEventListener('click', ()=>{
    const d = document.getElementById('attDate').value; if(!d) return alert('اختر تاريخ'); const tbody = document.querySelector('#attendanceTable tbody'); tbody.innerHTML=''; db.attendance.filter(a=>a.date===d).forEach(a=>{ const emp = db.employees.find(e=>e.id===a.empId)||{name:'--'}; const tr=document.createElement('tr'); tr.innerHTML=`<td>${emp.name}</td><td>${a.date}</td><td>${a.in||''}</td><td>${a.out||''}</td><td>${a.source||''}</td>`; tbody.appendChild(tr); });
  });
  document.getElementById('clearAttFilter').addEventListener('click', renderAttendance);

  // Utility render all
  function renderAll(){
    renderActivities(); renderEmployees(); renderAttendance(); renderLeaves(); renderLoans(); renderOverview(); renderAttendanceSelectors();
  }

  // Initial render
  renderAll();

  // Auto-save toggle
  document.getElementById('autoSave').addEventListener('change', ()=>{ if(document.getElementById('autoSave').checked) forceSave(); });

  // Ensure modals close when clicking outside
  document.querySelectorAll('.modal').forEach(m=>{ m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none'; }); });

// تحديث جميع القوائم التي تعرض أسماء الموظفين تلقائيًا عند أي تغيير
const employeeSelectors = [
  'attEmpSelect',
  'bioEmpSelect',
  'leaveEmp',
  'leaveEmpSelect',
  'loanEmpSelect',
  'loanEmp',
  'reportEmpSelect'
];

// دالة لتحديث القوائم بالأسماء الحالية
function updateAllEmployeeSelectors() {
  employeeSelectors.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = '';
    db.employees.forEach(emp => {
      const opt = document.createElement('option');
      opt.value = emp.id;
      opt.textContent = emp.name;
      sel.appendChild(opt);
    });
  });
}

// استدعاء أولي بعد تشغيل الصفحة
updateAllEmployeeSelectors();

// إعادة التحديث كل مرة يُضاف أو يُعدل فيها موظف
document.getElementById('saveEmpBtn').addEventListener('click', () => {
  setTimeout(updateAllEmployeeSelectors, 100); // يعطي فرصة لحفظ الموظف أولاً
});

// وأيضًا بعد حذف موظف
document.addEventListener('click', e => {
  if (e.target && e.target.dataset && e.target.dataset.act === 'del') {
    setTimeout(updateAllEmployeeSelectors, 100);
  }
});

  // System ready.
  </script>
</body>
</html>